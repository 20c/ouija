<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/twentyc.rest.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/twentyc.rest.Client.html">twentyc.rest.Client</a></li>
                                <li><a href="../classes/twentyc.rest.Form.html">twentyc.rest.Form</a></li>
                                <li><a href="../classes/twentyc.rest.List.html">twentyc.rest.List</a></li>
                                <li><a href="../classes/twentyc.rest.PermissionForm.html">twentyc.rest.PermissionForm</a></li>
                                <li><a href="../classes/twentyc.rest.Response.html">twentyc.rest.Response</a></li>
                                <li><a href="../classes/twentyc.rest.Select.html">twentyc.rest.Select</a></li>
                                <li><a href="../classes/twentyc.rest.Widget.html">twentyc.rest.Widget</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/twentyc.rest.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function(twentyc, $) {

/**
 * jquery function for closest descendant
 * credit: https://stackoverflow.com/a/8962023
 */

(function($) {
    $.fn.closest_descendant = function(filter) {
        var $found = $(),
            $currentSet = this.children(); // Current place
        while ($currentSet.length) {
            $found = $currentSet.filter(filter);
            if ($found.length) break;  // At least one match: break loop
            // Get all children of the current set
            $currentSet = $currentSet.children();
        }
        return $found.first(); // Return first match of the collection
    }
})(jQuery);

/**
 * namespace for twentyc.rest
 */

twentyc.rest = {

  /**
   * object holding global config
   * @type Object
   * @name config
   * @namespace twentyc.rest
   */

  config : {

    /**
     * set this to the CSRF token that should
     * be sent with write requests to the API
     * if any
     *
     * @type String
     * @name csrf
     * @namespace twentyc.rest.config
     */

    csrf : &quot;&quot;
  }
}

/**
 * Wrapper for API responses
 * @class Response
 * @constructor
 * @namespace twentyc.rest
 * @param {XHR Response} response
 * @param {Number} status
 */

twentyc.rest.Response = twentyc.cls.define(
  &quot;Response&quot;,
  {

    Response : function(response, status) {

      if(!response || (!response.data &amp;&amp; !response.errors) ) {
        this.status = status;
        return;
      }
      this.status = status;
      this.content = response;
    },

    /**
     * invokes a callback on each row in the api response
     * data resultset
     *
     * callback will be passed the data row as well as the index
     * of the row entry
     *
     * @method rows
     * @param {Function} callback
     */

    rows : function(callback) {
      var i;
      for(i = 0; i &lt; this.content.data.length; i++) {
        callback(this.content.data[i], i)
      }
    },

    /**
     * returns the first row in the api response
     * data resultset
     *
     * @method first
     * @returns {Object}
     */

    first : function() {
      if(this.content &amp;&amp; this.content.data) {
        return this.content.data[0];
      }
      return null;
    },

    /**
     * process field errors returned by the api
     * in a callback
     *
     * callback wil be invoked once for each field and
     * be passed an array of strings
     *
     * @method field_errors
     * @param {Function} callback
     */

    field_errors : function(callback) {
      if(!this.has_errors())
        return

      var key;
      for(key in this.content.errors) {
        if(key == &quot;non_field_errors&quot;)
          continue;

        callback(key, this.content.errors[key])
      }
    },

    /**
     * process non-field errors returned by the api
     * in a callback
     *
     * @method non_field_errors
     * @param {Function} callback
     */

    non_field_errors : function(callback) {
      if(!this.has_errors())
        return

      var nfe = this.content.errors.non_field_errors;

      if(typeof nfe == &quot;string&quot;)
        nfe = [nfe];

      if(nfe) {
        callback(nfe)
      }

    },

    /**
     * returns a user friendly error message for the
     * http status of the response
     *
     * @method http_status_text
     * @returns {String}
     */

    http_status_text : function() {
      if(this.status == 401) return &quot;Unauthorized Access&quot;;
      if(this.status == 403) return &quot;Permission Denied&quot;;
      if(this.status == 404) return &quot;Resource not found&quot;;
      if(this.status == 405) return &quot;Method not allowed&quot;;
      if(this.status == 429){
        if (this.content.errors.detail) return this.content.errors.detail;
        return &quot;Request is rate limited&quot;;
      }
      if(this.status == 500) return &quot;Internal Error&quot;;
      return &quot;Http Error &quot;+this.status;
    },

    /**
     * returns whether the response has error information
     * or not
     *
     * @method has_errors
     * @returns {Boolean}
     */

    has_errors : function() {
      if(this.status &gt; 400) {
        if(!this.content)
          this.content = {}
        if(!this.content.errors)
          this.content.errors = {}

        this.content.errors.non_field_errors =  [this.http_status_text()]
      }
      return ($.isEmptyObject(this.content.errors) == false);
    }
  }
);

/**
 * Base API functionality / connection handler
 *
 * @class Client
 * @constructor
 * @namespace twentyc.rest
 * @param {String} base_url path to the api root
 */

twentyc.rest.Client = twentyc.cls.define(
  &quot;Client&quot;,
  {
    Client : function(base_url) {
      this.base_url = base_url.replace(/\/$/g,&#x27;&#x27;);
    },

    /**
     * returns path to endpoint by appending
     * provided value to the api root base url
     * @method endpoint_url
     * @param {String} endpoint
     */

    endpoint_url : function(endpoint) {
      if(!endpoint)
        return this.base_url+&quot;/&quot;;
      return this.base_url+&quot;/&quot;+endpoint + &quot;/&quot;;
    },

    /**
     * Encodes and object literal to json
     * @method encode
     * @param {Object} data
     * @returns {String}
     */

    encode : function(data) {
      return JSON.stringify(data);
    },

    format_request_url : function(url, method) {
      return url;
    },

    /**
     * Perform a read request (GET, HEAD, OPTIONS) on the api
     *
     * @method read
     * @param {String} endpoint api endpoint
     * @param {Object} data url parameters to pass
     * @param {String} method http request method (GET, HEAD or OPTIONS)
     * @returns {Promise}
     */

    read : function(endpoint, data, method) {
      method = method.toLowerCase()
      $(this).trigger(&quot;api-request:before&quot;, [endpoint,data,method])
      $(this).trigger(&quot;api-read:before&quot;, [endpoint,data,method])
      $(this).trigger(&quot;api-&quot;+method+&quot;:before&quot;, [endpoint,data])
      var request = new Promise(function(resolve, reject) {
        $.ajax({
          method : method.toUpperCase(),
          data : data,
          url : this.format_request_url(this.endpoint_url(endpoint), method),
        }).done(function(result) {
          var response = new twentyc.rest.Response(result);
          $(this).trigger(&quot;api-request:success&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-read:success&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-&quot;+method+&quot;:success&quot;, [endpoint, data, response]);
          resolve(response);
        }.bind(this)).fail(function(e) {
          var response = new twentyc.rest.Response(e.responseJSON);
          $(this).trigger(&quot;api-request:error&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-read:error&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-&quot;+method+&quot;:error&quot;, [endpoint, data, response]);
          reject(response);
        }.bind(this)).always(function(e) {
          $(this).trigger(&quot;api-request:after&quot;, [endpoint, data, method]);
          $(this).trigger(&quot;api-read:after&quot;, [endpoint, data, method]);
          $(this).trigger(&quot;api-&quot;+method+&quot;:after&quot;, [endpoint, data]);
        }.bind(this));
      }.bind(this));

      return request;
    },

    /**
     * Perform a write request (POST, PUT, PATCH, DELETE) on the api
     *
     * @method write
     * @param {String} endpoint api endpoint
     * @param {Object} data payload
     * @param {String} method http request method
     * @returns {Promise}
     */

    write : function(endpoint, data, method) {
      method = method.toLowerCase();
      $(this).trigger(&quot;api-request:before&quot;, [endpoint,data,method])
      $(this).trigger(&quot;api-write:before&quot;, [endpoint,data,method])
      $(this).trigger(&quot;api-&quot;+method+&quot;:before&quot;, [endpoint,data])
      var request = new Promise(function(resolve, reject) {
        $.ajax({
          dataType : &quot;json&quot;,
          method : method.toUpperCase(),
          url : this.format_request_url(this.endpoint_url(endpoint), method),
          data : this.encode(data),
          headers : {
            &quot;Content-Type&quot; : &quot;application/json&quot;,
            &quot;X-CSRFToken&quot; : twentyc.rest.config.csrf
          },
        }).done(function(result) {
          var response = new twentyc.rest.Response(result);
          $(this).trigger(&quot;api-request:success&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-write:success&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-&quot;+method+&quot;:success&quot;, [endpoint, data, response]);
          resolve(response);
        }.bind(this)).fail(function(e) {
          var response = new twentyc.rest.Response(e.responseJSON, e.status);
          $(this).trigger(&quot;api-request:error&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-write:error&quot;, [endpoint, data, response, method]);
          $(this).trigger(&quot;api-&quot;+method+&quot;:error&quot;, [endpoint, data, response]);
          reject(response);
        }.bind(this)).always(function(e) {
          $(this).trigger(&quot;api-request:after&quot;, [endpoint, data, method]);
          $(this).trigger(&quot;api-write:after&quot;, [endpoint, data, method]);
          $(this).trigger(&quot;api-&quot;+method+&quot;:after&quot;, [endpoint, data]);
        }.bind(this));
      }.bind(this));

      return request;
    },

    /**
     * Wrapper to perform a &#x60;GET&#x60; request on the api
     *
     * @method get
     * @param {String} endpoint
     * @param {Object} params url parameters
     * @returns {Promise}
     */

    get : function(endpoint, params) {
      return this.read(endpoint, params, &quot;get&quot;);
    },

    /**
     * Wrapper to perform a &#x60;OPTIONS&#x60; request on the api
     *
     * @method options
     * @param {String} endpoint
     * @param {Object} params url parameters
     * @returns {Promise}
     */

    options : function(endpoint, params) {
      return this.read(endpoint, params, &quot;options&quot;);
    },

    /**
     * Wrapper to perform a &#x60;POST&#x60; request on the api
     *
     * @method post
     * @param {String} endpoint
     * @param {object} data payload
     * @returns {Promise}
     */

    post : function(endpoint, data) {
      return this.write(endpoint, data, &quot;post&quot;);
    },

    /**
     * Wrapper to perform a &#x60;PUT&#x60; request on the api
     *
     * @method post
     * @param {String} endpoint
     * @param {object} data payload
     * @returns {Promise}
     */

    put : function(endpoint, data) {
      return this.write(endpoint, data, &quot;put&quot;);
    },

    /**
     * Wrapper to perform a &#x60;DELETE&#x60; request on the api
     *
     * @method post
     * @param {String} endpoint
     * @param {object} data payload
     * @returns {Promise}
     */


    delete : function(endpoint, data) {
      return this.write(endpoint, data, &quot;delete&quot;);
    }
  }
);

/**
 * Base class for API widgets
 *
 * @class Widget
 * @extends twentyc.rest.Client
 * @namespace twentyc.rest
 * @constructor
 * @param {String} base_url api root
 * @param {jQuery result} jq jquery result holding the main element of the widget
 */

twentyc.rest.Widget = twentyc.cls.extend(
  &quot;Widget&quot;,
  {
    Widget : function(base_url, jq) {
     this.action = jq.data(&quot;api-action&quot;)

     /**
      * allows you to define local actions (experimental)
      * @property {Object} local_actions
      */
     this.local_actions = {}
     this.Client(base_url);
     this.bind(jq);
    },

    /**
     * Sets the widget state to processing
     *
     * This will trigger the &#x60;processing&#x60; event
     *
     * @method start_processing
     */

    start_processing : function() {
      this.busy = true
      if(!this.loading_shim) {
        this.loading_shim = $(&#x27;&lt;div&gt;&#x27;).addClass(&quot;loading-shim&quot;)
        this.element.append(this.loading_shim);
      }
      if(!this.loading_shim_disabled)
        this.loading_shim.show();

      $(this).trigger(&quot;processing&quot;);
    },


    /**
     * Sets the widget state to ready or done with processing
     *
     * This will trigger the &#x60;ready&#x60; event
     *
     * @method done_processing
     */

    done_processing : function() {
      this.busy = false
      if(this.loading_shim &amp;&amp; !window.debug_loading_shim)
        this.loading_shim.hide();
      $(this).trigger(&quot;ready&quot;);
    },

    /**
     * Clones a template element by name and returns it
     *
     * Templates for a widget should be stored within an element inside
     * the widget that has it&#x27;s &#x60;.templates&#x60; css class set
     *
     * A template is designated a template if it has the
     * &#x60;data-template&#x60; attribute set to hold the template name
     *
     * &#x60;&#x60;&#x60;html
     * &lt;div class=&quot;widget&quot;&gt;
     *  &lt;div class=&quot;templates&quot;&gt;
     *    &lt;div data-template=&quot;my_template&quot;&gt;&lt;/div&gt;
     *  &lt;/div&gt;
     * &lt;/div&gt;
     * &#x60;&#x60;&#x60;
     *
     * &#x60;&#x60;&#x60;javascript
     * var tmpl = widget.template(&#x27;my_template&#x27;)
     * &#x60;&#x60;&#x60;
     *
     * @method template
     * @param {String} name template name (as specified in data-template)
     * @returns {jQuery result} jquery result holding the cloned template node
     */

    template : function(name) {
      var tmpl = this.element.closest_descendant(&#x27;.templates&#x27;).find(&#x27;[data-template=&quot;&#x27;+name+&#x27;&quot;]&#x27;)
      var clone = tmpl.clone().attr(&#x27;data-template&#x27;, null);
      return clone;
    },

    /**
     * Binds the widget to a html element
     *
     * @method bind
     * @param {jQuery result} jq jquery result holding the html element
     */

    bind : function(jq) {
      jq.data(&quot;rest_widget&quot;, this);
      this.element = jq;

      this.redirect = this.element.data(&quot;api-redirect&quot;)

      $(this).on(&quot;api-write:before&quot;, function() {
        this.clear_errors();
        this.start_processing();
      }.bind(this));

      $(this).on(&quot;api-write:after&quot;, function() {
        this.done_processing();
      }.bind(this));

      $(this).on(&quot;api-read:before&quot;, function() {
        this.start_processing();
      }.bind(this));

      $(this).on(&quot;api-read:after&quot;, function() {
        this.done_processing();
      }.bind(this));
    },

    /**
     * Defines a local action that some widget&#x27;s
     * may invoke
     *
     * Local actions can be set on the widget element or sub elements
     * via the &#x60;data-action&#x60; attribute
     *
     * @method local_action
     * @param {String} name action name
     * @param {Function} fn
     */

    local_action : function(name, fn) {
      this.local_actions[name] = fn;
    },

    /**
     * Clears all validation / input errors for the widget
     *
     * @method clear_errors
     */

    clear_errors : function() {
      this.element.find(&#x27;.validation-error&#x27;).detach();
      this.element.find(&#x27;.validation-error-indicator&#x27;).removeClass(&quot;validation-error-indicator&quot;);
    },

    /**
     * Renders field errors (think input vaidation errors)
     *
     * @method render_error
     * @param {String} key field name
     * @param {Array} errors list of error strings
     */

    render_error : function(key, errors) {
      var i;
      var error_node = $(&#x27;&lt;div&gt;&#x27;).addClass(&quot;validation-error&quot;);
      var input = this.element.find(&#x27;[name=&quot;&#x27;+key+&#x27;&quot;]&#x27;);
      input.addClass(&quot;validation-error-indicator&quot;)
      for(i = 0; i &lt; errors.length; i++) {
        error_node.append($(&#x27;&lt;p&gt;&#x27;).text(errors[i]))
      }
      if(input.attr(&quot;type&quot;) != &quot;checkbox&quot;)
        error_node.insertAfter(input);
    },

    /**
     * Renders non field errors (think server errors, generic errors)
     *
     * @method render_non_field_errors
     * @param {Array} errors list of error strings
     */

    render_non_field_errors : function(errors) {
      var error_node = $(&#x27;&lt;div&gt;&#x27;).addClass(&quot;alert alert-danger validation-error non-field-errors&quot;);
      let i;
      for(i = 0; i &lt; errors.length; i++) {
        $(twentyc.rest).trigger(&quot;non-field-error&quot;, [errors[i], errors, i, error_node, this]);
        if(errors[i])
          error_node.append($(&#x27;&lt;div&gt;&#x27;).addClass(&quot;non-field-error&quot;).text(errors[i]))
      }
      this.element.prepend(error_node)
    },

    /**
     * Prepares the payload for the widget&#x27;s write request
     * by checking for form elements and converting their values
     * to an object literal compatible to be sent as a payload
     *
     * @param payload
     * @returns {Object}
     */

    payload : function() {
      var data = {};
      this.element.find(&#x27;[data-api-submit=&quot;yes&quot;]&#x27;).each(function() {
        $(this).find(&quot;input,select,textarea&quot;).each(function() {
          var input = $(this)
          if(input.attr(&quot;type&quot;) == &quot;checkbox&quot;) {
            if(input.prop(&quot;checked&quot;))
              data[input.attr(&quot;name&quot;)] = true;
            else
              data[input.attr(&quot;name&quot;)] = false;
          } else {
            data[input.attr(&quot;name&quot;)] = input.val();
          }
        });
      });
      return data;

    },


  },
  twentyc.rest.Client
);

/**
 * Form widget that binds a HTML form to the REST api
 *
 * The form element should have the following attributes set
 *
 * # required
 *
 * - data-api-base: api root or full path to endpoint
 *
 * # optional
 *
 * - data-api-action: if specified will be appended as endpoint to data-api-base
 * - data-api-method: request method for writes, defaults to POST
 *
 * If the form element contains a button element with the
 * &#x60;submit&#x60; css class set it will be wired to submit the form
 * on click
 *
 * @class Form
 * @extends twentyc.rest.Widget
 * @namespace twentyc.rest
 * @param {jQuery result} jq form element
 */

twentyc.rest.Form = twentyc.cls.extend(
  &quot;Form&quot;,
  {
    Form : function(jq) {
      var base_url = jq.data(&quot;api-base&quot;)
      this.form_action = jq.data(&quot;api-action&quot;)
      this.Widget(base_url, jq);
    },

    /**
     * Fill the form fields from values provided in
     * an object literal thats keyed by field name
     *
     * Names in &#x60;data&#x60; will be matched against the &#x60;name&#x60; attribute
     * of the form inputs
     *
     * @method fill
     * @param {Object} data
     */

    fill : function(data) {
      var key, value;
      this.clear_errors();
      for(key in data) {
        value = data[key];
        this.element.find(&#x27;[name=&quot;&#x27;+key+&#x27;&quot;]&#x27;).each(function() {
          if($(this).attr(&quot;type&quot;) == &quot;checkbox&quot;) {
            $(this).prop(&quot;checked&quot;, value);
          } else {
            $(this).val(value);
          }
        });

        this.element.find(&#x27;[data-field=&quot;&#x27;+key+&#x27;&quot;]&#x27;).each(function() {
          $(this).text(value);
        });
      }
    },


    reset : function() {
      var k ,empty = {};
      for(k in this.payload()) {
        empty[k] = &quot;&quot;
      }
      this.fill(empty);
    },

    post_success : function(result) {

    },

    post_failure : function(response) {
      response.field_errors(this.render_error.bind(this));
      response.non_field_errors(this.render_non_field_errors.bind(this))
    },

    /**
     * Submit the form using the specified method
     *
     * @method submit
     * @param {String} method http request method
     */

    submit : function(method) {
      this.clear_errors();

      if(!method)
        method = this.method

      var fn = this[method.toLowerCase()].bind(this);
      fn(this.form_action, this.payload()).then(
        this.post_success.bind(this),
        this.post_failure.bind(this)
      );
    },

    /**
     * Binds the form widget to a html element
     *
     * This is called automatically in the constructor
     *
     * @method bind
     * @param {jQuery result} jq
     */

    bind : function(jq) {
      this.Widget_bind(jq);
      this.method = jq.data(&quot;api-method&quot;) || &quot;POST&quot;;

      this.element.find(&#x27;input&#x27;).keydown(function(event){
        if(event.keyCode == 13) {
          event.preventDefault();
          this.submit();
          return false;
        }
      }.bind(this));

      var widget = this;


      this.element.find(&#x27;button&#x27;).click(function(event) {
        event.preventDefault();
        return false;
      });

      this.element.find(&#x27;button.submit,button[data-element=&quot;submit&quot;]&#x27;).click(function(event) {
        event.preventDefault();
        widget.submit(
          $(this).data(&quot;api-method&quot;)
        );
        return false;
      });
    },

    /**
     * Wires a button to submit the form
     *
     * @method wire_submit
     * @param {jQuery result} jq_button jquery result holding button element
     */

    wire_submit : function(jq_button) {
      var widget = this;
      jq_button.off(&quot;click&quot;).click(function() {
        widget.submit($(this).data(&quot;api-method&quot;))
      });
    }
  },
  twentyc.rest.Widget
);


twentyc.rest.Input = twentyc.cls.extend(
  &quot;Input&quot;,
  {
    Input : function(jq) {
      var base_url = jq.data(&quot;api-base&quot;);
      this.Widget(base_url, jq);
    },

    /**
     * Sets the widget state to processing
     *
     * This will trigger the &#x60;processing&#x60; event
     *
     * @method start_processing
     */

    start_processing : function() {
      this.busy = true
      this.element.prop(&quot;disabled&quot;, true);
      $(this).trigger(&quot;processing&quot;);
    },


    /**
     * Sets the widget state to ready or done with processing
     *
     * This will trigger the &#x60;ready&#x60; event
     *
     * @method done_processing
     */

    done_processing : function() {
      this.busy = false
      this.element.prop(&quot;disabled&quot;, false);
      $(this).trigger(&quot;ready&quot;);
    },


    post_success : function(result) {

    },

    post_failure : function(response) {
      console.error(response);
      response.field_errors(this.render_error.bind(this));
      response.non_field_errors(this.render_non_field_errors.bind(this))
    },


    bind : function(jq) {
      this.Widget_bind(jq);
      this.method = jq.data(&quot;api-method&quot;) || &quot;POST&quot;;

      this.element.on(&quot;keyup&quot;, function(ev) {
        this.clear_errors();

        if(ev.which != 13)
          return;

        var action = this.action;
        var fn = this[this.method.toLowerCase()].bind(this);

        fn(action, this.payload()).then(
          this.post_success.bind(this),
          this.post_failure.bind(this)
        );
      }.bind(this));
    }

  },
  twentyc.rest.Widget
);


twentyc.rest.Button = twentyc.cls.extend(
  &quot;Button&quot;,
  {
    bind : function(jq) {
      this.Widget_bind(jq);
      this.method = jq.data(&quot;api-method&quot;) || &quot;POST&quot;;

      this.element.on(&quot;mouseup&quot;, function(ev) {

        var confirm_required = this.element.data(&quot;confirm&quot;);
        if(confirm_required &amp;&amp; !confirm(confirm_required))
          return;

        this.clear_errors();

        var action = this.action;
        var fn = this[this.method.toLowerCase()].bind(this);

        fn(action, this.payload()).then(
          this.post_success.bind(this),
          this.post_failure.bind(this)
        );
      }.bind(this));

    }
  },
  twentyc.rest.Input
);

/**
 * Wires a &#x60;select&#x60; element to the API
 *
 * The select element should have the following attributes set
 *
 * # required
 *
 * - data-api-base: api root or full path to endpoint
 *
 * # optional
 *
 * - data-api-load: endpoint that should be requested to load options
 * - data-name-field: which data resultset field to use for option text,
 *   defaults to &quot;name&quot;
 * - data-id-field: which data resultset field to use for option value,
 *   defaultd to &quot;id&quot;
 * - data-selected-field: which data resultset field to check whether and option
 *   should be auto-selected, defaults to &quot;selected&quot;
 * - data-load-type: what load method to use, can be &quot;get&quot; or &quot;drf-choices&quot;,
 *   with the latter being a way to load in django-rest-framework field values
 *   choices. Defaults to &quot;get&quot;
 * - data-drf-name: relevant if load type is &quot;drf-choices&quot;. Specifies the
 *   serializer field name, will default to &quot;name&quot; attribute if not specified.
 *
 * @class Select
 * @extends twentyc.rest.widget
 * @namespace twentyc.rest
 * @param {jQuery result} jq jquery result holding the select element
 */

twentyc.rest.Select = twentyc.cls.extend(
  &quot;Select&quot;,
  {
    Select : function(jq) {
      this.load_action = jq.data(&quot;api-load&quot;)
      this.name_field = jq.data(&quot;name-field&quot;) || &quot;name&quot;
      this.id_field = jq.data(&quot;id-field&quot;) || &quot;id&quot;
      this.selected_field = jq.data(&quot;selected-field&quot;) || &quot;selected&quot;
      this.load_type = jq.data(&quot;load-type&quot;) || &quot;get&quot;
      this.drf_name = jq.data(&quot;drf-name&quot;) || jq.attr(&quot;name&quot;);
      this.null_option = jq.data(&quot;null-option&quot;)
      this.proxy_data = jq.data(&quot;proxy-data&quot;)
      this.Input(jq);
    },

    payload: function() {
      return { &quot;id&quot;: this.element.val() }
    },

    load_params : function() {
      return null;
    },

    filter : function(item) {
      return true;
    },


    /**
     * loads options from the api
     *
     * this will call _load_get or _load_drf_choices depending
     * on which load-type is specified (see data-load-type attribute)
     *
     * triggers load:after event
     *
     * @method load
     * @param {Mixed} select_this if specified will select this value after
     *   load
     */

    load : function(select_this) {

      if(this.proxy_data) {
        var select = this.element;
        select.empty();

        $(this.proxy_data).find(&#x27;option&#x27;).each(function() {
          select.append($(this).clone());
        });
        return;
      }

      if(this.load_type == &quot;drf-choices&quot;)
        return this._load_drf_choices(select_this);

      return this._load_get(select_this);

    },

    /**
     * loads data in via a GET request
     *
     * expects data to come back as a list of object literals
     * containing keys for &#x60;this.name_field&#x60; and &#x60;this.id_field&#x60;
     *
     * this method is called automatically by &#x60;this.load&#x60; if the
     * the load-type of the select widget is set to &quot;get&quot;
     *
     * Example assuming this.name_field == &#x27;name&#x27; and this.id_field = &#x27;id&#x27;
     *
     * {
     *   &quot;data&quot;: [
     *     { &quot;name&quot;: &quot;Choice 1&quot;, &quot;id&quot;: 1 },
     *     { &quot;name&quot;: &quot;Choice 2&quot;, &quot;id&quot;: 2 }
     *   ]
     * }
     *
     * @method _load_get
     * @private
     * @param {Mixed} select_this if specified will select this value after
     *   load
     */

    _load_get : function(select_this) {


      return this.get(null, this.load_params()).then(function(response) {
        var select = this.element;
        var name_field = this.name_field
        var id_field = this.id_field
        var selected_field = this.selected_field
        var widget = this;

        select.empty();

        if(this.null_option) {
          let null_parts = this.null_option.split(&quot;;&quot;);
          select.append($(&#x27;&lt;option&gt;&#x27;).val(null_parts[0]).text(null_parts[1]));
        }


        $(response.content.data).each(function() {
          if(!widget.filter(this))
            return;
          var selected = this[selected_field] || false;
          var opt = $(&#x27;&lt;option&gt;&#x27;).val(this[id_field]).text(this[name_field])
          if(selected)
            opt.attr(&quot;selected&quot;, true);
          select.append(opt);
        });

        if(select_this)
          select.val(select_this);

        $(this).trigger(&quot;load:after&quot;, [select, response.content.data, this]);
      }.bind(this));
    },

    /**
     * loads data in via a OPTIONS request to a django-rest-framework
     * api endpoint
     *
     * this method is called automatically by &#x60;this.load&#x60; if the
     * the load-type of the select widget is set to &quot;drf_choices&quot;
     *
     * @method _load_drf_choices
     * @private
     * @param {Mixed} select_this if specified will select this value after
     *   load
     */

    _load_drf_choices : function(select_this) {
      return this.options().then(function(response) {
        var select = this.element.empty();
        var options = response.content.data[0].actions.POST[this.drf_name].choices;

        if(this.null_option) {
          let null_parts = this.null_option.split(&quot;;&quot;);
          select.append($(&#x27;&lt;option&gt;&#x27;).val(null_parts[0]).text(null_parts[1]));
        }


        $(options).each(function() {
          select.append(
            $(&#x27;&lt;option&gt;&#x27;).val(this.value).text(this.display_name)
          )
        });

        if(select_this)
          select.val(select_this);

      }.bind(this));
    },

    /**
     * refreshes options from the api
     *
     * this is the same as load, but will maintain the current
     * selection choice as long as it still exists in the the
     * fresh dataset
     *
     * @method refresh
     */

    refresh : function() {
      var val = this.element.val()
      return this.load().then(
       () =&gt; { this.element.val(val); },
       () =&gt; {}
      );
    },

    prepare_write_url : function(url) {
      return url;
    },


    bind : function(jq) {
      this.Widget_bind(jq);
      this.method = jq.data(&quot;api-method&quot;) || &quot;POST&quot;;

      if(this.load_action)
        this.load();

      this.element.on(&quot;change&quot;, function() {
        this.clear_errors();

        if(!this.action)
          return;

        var action = this.action;
        var fn = this[this.method.toLowerCase()].bind(this);

        fn(action, this.payload()).then(
          this.post_success.bind(this),
          this.post_failure.bind(this)
        );
      }.bind(this));
    }
  },
  twentyc.rest.Input
);

/**
 * Data listing widget
 *
 * A way to visualize an api data response in a table
 *
 * # element attributes
 *
 * This widget element should have these html attributes set
 *
 * ## required
 *
 * - data-api-base: api root or full path to endpoint
 *
 * ## optional
 *
 * - data-api-action: if specified will be appended as endpoint to data-api-base
 *
 * # DOM structure
 *
 * The widget element should contain the following child elements
 *
 * - element with &#x60;list-body&#x60; css class, which will serve as a
 *   container for rows, if your widget element is a table this
 *   would be a tbody element.
 * - element with data-template=&quot;row&quot; attr set, which will be used
 *   to clone for individual rows
 *
 *   within the row element, child elements will be scanned for
 *   data-field attributes to match against the field names in the api
 *   result set.
 *
 * # Example
 *
 * &#x60;&#x60;&#x60;json
 * {
 *   &quot;data&quot;: [
 *      { &quot;id&quot;: 1, &quot;name&quot;: &quot;first row&quot; },
 *      {&quot; id&quot;: 2, &quot;name&quot;: &quot;second row&quot; }
 *   ]
 * }
 * &#x60;&#x60;&#x60;
 *
 * &#x60;&#x60;&#x60;html
 * &lt;table data-api-base=&quot;/api/my_list&quot; id=&quot;my_list&quot;&gt;
 *  &lt;tbody class=&quot;list-body&quot;&gt;&lt;/tbody&gt;
 *  &lt;tbody class=&quot;templates&quot;&gt;
 *    &lt;tr data-template=&quot;row&quot;&gt;
 *      &lt;td data-field=&quot;id&quot;&gt;&lt;/td&gt;
 *      &lt;td data-field=&quot;name&quot;&gt;&lt;/td&gt;
 *    &lt;/tr&gt;
 *  &lt;/tbody&gt;
 * &lt;/table&gt;
 * &#x60;&#x60;&#x60;
 *
 * &#x60;&#x60;&#x60;javascript
 * var list = new twentyc.rest.List($(&#x27;#my_list&#x27;))
 * list.load();
 * &#x60;&#x60;&#x60;
 *
 *
 * @class List
 * @extends twentyc.rest.Widget
 * @namespace twentyc.rest
 * @constructor
 * @param {jQuery result} jq jquery result holding widget element (table)
 */

twentyc.rest.List = twentyc.cls.extend(
  &quot;List&quot;,
  {
    List : function(jq) {
      var base_url = jq.data(&quot;api-base&quot;)

      this.id_field = &quot;id&quot;
      this.formatters = {}

      this.Widget(base_url, jq);
      this.list_head = this.element.find(&#x27;thead,.list-header&#x27;).first();
      this.initialize_sorting();
    },

    /**
     * loads rows into the list
     *
     * this empties all current rows before it does so
     *
     * triggers load:after event
     *
     * @method load
     */

    load : function() {
      if(this.sortable)
        this.apply_ordering();

      return this.get(this.action, this.payload()).then(function(response) {
        this.list_body.empty()
        response.rows(function(row, idx) {
          this.insert(row);
        }.bind(this));
        $(this).trigger(&quot;load:after&quot;);
        return
      }.bind(this));
    },

    /**
     * reload single row
     */

    reload_row : function(id) {
      var row = this.find_row(id);
      if(row) {
        return this.get(id, this.payload()).then(function(response) {
          var new_row = this.insert(response.first())
          new_row.insertAfter(row);
          row.detach();
        }.bind(this));
      }
    },

    /**
     * insert a new row from object
     *
     * triggers insert:after event
     *
     * @method insert
     * @param {Object} data
     */

    insert : function(data) {
      var toggle, k, row_element, col_element;

      row_element = this.template(&#x27;row&#x27;)

      for(k in data) {
        var val, formatter = this.formatters[k];
        col_element = row_element.find(&#x27;[data-field=&quot;&#x27;+k+&#x27;&quot;]&#x27;)
        toggle = col_element.data(&quot;toggle&quot;)
        if(toggle) {
          if(data[k]) {
            col_element.addClass(toggle);
          } else {
            col_element.removeClass(toggle);
          }
        } else if(!formatter) {
          col_element.text(data[k]).val(data[k])
        } else {
          val = formatter(data[k], data, col_element)
          col_element.empty().append(val)
        }
      }

      if(this.formatters.row)
        this.formatters.row(row_element, data)

      row_element.data(&quot;apiobject&quot;, data);
      row_element.addClass(&quot;row-&quot;+data[this.id_field])

      this.list_body.append(row_element)
      this.wire(row_element)

      $(this).trigger(&quot;insert:after&quot;, [row_element, data]);

      return row_element;
    },

    api_callback_remove : function(response) {
      response.rows(function(row) {
        this.remove(row)
      }.bind(this));
    },

    /**
     * Removes the row for the supplied api response row object
     *
     * @method remove
     * @param {Object} data
     */

    remove : function(data) {
      $(this).trigger(&quot;remove:before&quot;, [data]);
      this.list_body.find(&#x27;.row-&#x27;+data[this.id_field]).detach();
    },

    /**
     * return row element for object id
     *
     * @method find_row
     * @param {String} id
     * @returns {jQuery result}
     */

    find_row : function(id) {
      return this.list_body.find(&#x27;.row-&#x27;+(&quot;&quot;+id).replace(&#x27;:&#x27;,&#x27;\\:&#x27;));
    },

    action_failure : function(response) {
      response.field_errors(this.render_error.bind(this));
      response.non_field_errors(this.render_non_field_errors.bind(this))
    },

    wire : function(row) {
      var widget = this;

      row.find(&#x27;a[data-action]&#x27;).click(function() {
        var actionName = $(this).data(&quot;action&quot;)
        if(widget.local_actions[actionName]) {
          widget.local_actions[actionName](row.data(&quot;apiobject&quot;), row);
        }
      });

      row.find(&#x27;a[data-api-action], button[data-api-action]&#x27;).each(function() {
        var method = ($(this).data(&quot;api-method&quot;) || &quot;POST&quot;).toLowerCase();
        var action = $(this).data(&quot;api-action&quot;).toLowerCase();
        var callback = $(this).data(&quot;api-callback&quot;);
        var confirm_set = $(this).data(&quot;confirm&quot;)

        if(callback)
          callback = widget[&quot;api_callback_&quot;+callback].bind(widget)

        $(this).click(function() {
          if(confirm_set &amp;&amp; !confirm(confirm_set))
            return;
          var apiobj = row.data(&quot;apiobject&quot;)
          var _action = action.replace(
            /\{([^\{\}]+)\}/,
            (match, p1, offset, string) =&gt; {
              return apiobj[p1];
            }
          )
          widget[method](_action, row.data(&quot;apiobject&quot;)).then(
            callback, widget.action_failure.bind(widget)
          );
        });
      });
    },

    bind : function(jq) {
      this.Widget_bind(jq);

      this.list_body = jq.find(&quot;.list-body&quot;)
    },

    payload : function() {
      if(this.ordering) {
        return { ordering: this.ordering };
      }
      return {};
    },

    /**
     * sorting
     */

    initialize_sorting: function() {
      var widget = this;

      this.sort_headings = this.list_head.find(&#x27;[data-sort-target]&#x27;);
      this.sortable = (this.sort_headings.length &gt; 0);

      if(!this.sortable)
        return;

      this.sort_headings.click(function (){
        var button = $(this)
        widget.sort(button.data(&quot;sort-target&quot;), button.data(&quot;sort-secondary&quot;));
      });

      let sort_button = this.sort_headings.filter(&quot;[data-sort-initial]&quot;);
      this.sort_target = sort_button.data(&quot;sort-target&quot;);
      this.sort_secondary = sort_button.data(&quot;sort-secondary&quot;);

      this.sort_asc = true;
      this.ordering = &quot;&quot;;

      /*
      Specific to django-rest-framework: we add &quot;ordering&quot; as a query
      parameter to the API calls
      */
      this.payload = function(){return {ordering: this.ordering}}

      console.log(&quot;sort init&quot;, this);
    },

    sort: function(target, secondary) {
      this.sort_secondary = secondary;
      if ( target == this.sort_target ){
          this.sort_asc = !this.sort_asc;
      } else {
          this.sort_target = target;
          this.sort_asc = true;
      };
      this.load();
    },

    apply_ordering : function() {
      this.ordering = this.return_ordering();
      this.indicate_ordering();
    },

    return_ordering: function() {
      let secondary = (this.sort_secondary ? &quot;,&quot;+this.sort_secondary : &quot;&quot;)
      if ( this.sort_asc ){
        return this.sort_target + secondary;
      }
      return &quot;-&quot; + this.sort_target + secondary;
    },


    indicate_ordering : function() {
      let heading = this.sort_target;
      let asc = this.sort_asc;

      $(this.sort_headings).each( function() {
        $(this).find(&quot;span&quot;).remove();
        if ( $(this).data(&quot;sort-target&quot;) == heading ){
          if ( asc ){
            $(this).removeClass(&quot;selected-order-header-desc&quot;)
            $(this).addClass(&quot;selected-order-header-asc&quot;);
          } else {
            $(this).removeClass(&quot;selected-order-header-asc&quot;)
            $(this).addClass(&quot;selected-order-header-desc&quot;);
          }
        } else {
            $(this).removeClass(&quot;selected-order-header-asc&quot;);
            $(this).removeClass(&quot;selected-order-header-desc&quot;);
        }
      })
    },


  },
  twentyc.rest.Widget
);

/**
 * Special form widget for handling user permissions
 *
 * This expect a form element that contains checkboxes for
 * permission flags
 *
 * Each checkbox element should have these attributes set
 *
 * - data-permission-flag unique flag name to describe the permssion level
 *
 * # Example
 *
 * &#x60;&#x60;&#x60;html
 * &lt;span&gt;&lt;input data-permission-flag=&quot;c&quot; type=&quot;checkbox&quot;&gt; create&lt;/span&gt;
 * &lt;span&gt;&lt;input data-permission-flag=&quot;r&quot; type=&quot;checkbox&quot;&gt; read&lt;/span&gt;
 * &lt;span&gt;&lt;input data-permission-flag=&quot;u&quot; type=&quot;checkbox&quot;&gt; update&lt;/span&gt;
 * &lt;span&gt;&lt;input data-permission-flag=&quot;d&quot; type=&quot;checkbox&quot;&gt; delete&lt;/span&gt;
 * &#x60;&#x60;&#x60;
 * @class PermissionForm
 * @extends twentyc.rest.Form
 * @namespace twentyc.rest
 * @constructor
 */

twentyc.rest.PermissionsForm = twentyc.cls.extend(
  &quot;PermissionsForm&quot;,
  {

    /**
     * Updates the checkboxes states according to the flags
     * provided
     *
     * For example passing &#x60;crud&#x60; would check all checkboxes
     * while passing &#x60;r&#x60; would only check the checkbox for read access
     *
     * @method set_flag_values
     * @param {String} flags
     */

    set_flag_values : function(flags) {
      this.element.find(&#x27;input[data-permission-flag]&#x27;).each(function() {
        var flag_name = $(this).data(&quot;permission-flag&quot;)
        if(flag_name.length == 1) {
          var value = (flags.perms.indexOf(flag_name) &gt; -1)
        } else {
          var i, value = true;
          for(i = 0; i &lt; flag_name.length; i++) {
            if(flags.perms.indexOf(flag_name.charAt(i)) == -1)
              value = false;
          }
        }
        $(this).prop(&quot;checked&quot;, value)
      });
    },

    payload : function() {
      var payload = this.Form_payload();
      payload.permissions = &quot;&quot;
      this.element.find(&#x27;input[data-permission-flag]&#x27;).each(function() {
        if($(this).prop(&quot;checked&quot;))
          payload.permissions += $(this).data(&quot;permission-flag&quot;)
      });

      return payload;
    },

    bind : function(jq) {
      this.Widget_bind(jq);
      this.method = jq.data(&quot;api-method&quot;) || &quot;POST&quot;;
      this.element.find(&#x27;input[data-permission-flag]&#x27;).on(&quot;change&quot;, function() {
        this.clear_errors();
        var fn = this[this.method.toLowerCase()].bind(this);
        fn(this.action, this.payload()).then(
          this.post_success.bind(this),
          this.post_failure.bind(this)
        );
      }.bind(this));

    }
  },
  twentyc.rest.Form
);





})(twentyc, jQuery);

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
